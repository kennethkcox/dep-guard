name: Security & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==================================================================
  # Job 1: Production Code Security Audit
  # ==================================================================
  production-security-audit:
    name: Production Code Security (Excluding Test Apps)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit on production dependencies
        id: npm-audit
        run: |
          echo "::group::NPM Audit Results"
          npm audit --audit-level=moderate --production
          echo "::endgroup::"
        continue-on-error: true

      - name: Scan production code with DepGuard
        id: depguard-scan
        run: |
          # Create a temporary package.json for scanning only production code
          cat > /tmp/scan-config.json << 'EOFCONFIG'
          {
            "name": "depguard-production-scan",
            "version": "1.0.0",
            "dependencies": $(jq '.dependencies' package.json)
          }
          EOFCONFIG

          # Scan only the root package.json (production dependencies)
          echo "::group::DepGuard Production Scan"
          node bin/depguard.js scan -p . -o json -f depguard-production.json
          node bin/depguard.js scan -p .
          echo "::endgroup::"

      - name: Analyze scan results
        id: analyze
        run: |
          # Check if the JSON file exists and is valid
          if [ ! -f "depguard-production.json" ]; then
            echo "::error::DepGuard report not generated"
            exit 1
          fi

          # Extract statistics from the report
          TOTAL_VULNS=$(jq -r '.statistics.totalVulnerabilities // 0' depguard-production.json)
          REACHABLE_VULNS=$(jq -r '.statistics.reachableVulnerabilities // 0' depguard-production.json)
          CRITICAL=$(jq -r '.statistics.critical // 0' depguard-production.json)
          HIGH=$(jq -r '.statistics.high // 0' depguard-production.json)
          MEDIUM=$(jq -r '.statistics.medium // 0' depguard-production.json)

          echo "total_vulns=$TOTAL_VULNS" >> $GITHUB_OUTPUT
          echo "reachable_vulns=$REACHABLE_VULNS" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT

          # Create summary
          echo "## DepGuard Production Code Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Vulnerabilities | $TOTAL_VULNS |" >> $GITHUB_STEP_SUMMARY
          echo "| Reachable Vulnerabilities | $REACHABLE_VULNS |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Severity | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High Severity | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium Severity | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Filter for production code only (exclude examples/)
          PROD_VULNS=$(jq '[.results[] | select(.vulnerability.package | startswith("examples/") | not)] | length' depguard-production.json)
          echo "production_vulns=$PROD_VULNS" >> $GITHUB_OUTPUT

          if [ "$PROD_VULNS" -gt 0 ]; then
            echo "::warning::Found $PROD_VULNS reachable vulnerabilities in production code"
            echo "âŒ **Status:** $PROD_VULNS reachable vulnerabilities found in production code" >> $GITHUB_STEP_SUMMARY
          else
            echo "::notice::Production code is secure - 0 reachable vulnerabilities âœ“"
            echo "âœ… **Status:** Production code is secure (0 reachable vulnerabilities)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload DepGuard production report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depguard-production-report
          path: depguard-production.json
          retention-days: 90

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('depguard-production.json', 'utf8'));

            const totalVulns = report.statistics?.totalVulnerabilities || 0;
            const reachableVulns = report.statistics?.reachableVulnerabilities || 0;

            const comment = `## ðŸ›¡ï¸ DepGuard Security Scan Results

            **Production Code Analysis:**
            - Total vulnerabilities found: ${totalVulns}
            - Reachable vulnerabilities: ${reachableVulns}
            - Status: ${reachableVulns === 0 ? 'âœ… Secure' : 'âš ï¸ Needs attention'}

            ðŸ“Š [View detailed report in artifacts](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==================================================================
  # Job 2: Comprehensive Test Suite
  # ==================================================================
  test-suite:
    name: Test Suite (98 Tests)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run test suite
        run: npm test -- --verbose

      - name: Generate coverage report
        run: npm test -- --coverage --coverageReporters=json-summary
        continue-on-error: true

      - name: Report coverage
        if: matrix.node-version == 20
        run: |
          COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json 2>/dev/null || echo "N/A")
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "Line Coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY

          if [ "$COVERAGE" != "N/A" ]; then
            if (( $(echo "$COVERAGE > 70" | bc -l) )); then
              echo "::notice::Test coverage is $COVERAGE% âœ“"
            else
              echo "::warning::Test coverage is $COVERAGE% (target: >70%)"
            fi
          fi

  # ==================================================================
  # Job 3: Dependency Health Check
  # ==================================================================
  dependency-health:
    name: Dependency Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "::group::Outdated Packages"
          npm outdated --json > outdated.json || true
          cat outdated.json | jq '.' || echo "{}"
          echo "::endgroup::"

          OUTDATED_COUNT=$(cat outdated.json | jq 'length' 2>/dev/null || echo "0")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

          echo "## Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$OUTDATED_COUNT" -eq 0 ]; then
            echo "âœ… All dependencies are up-to-date" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ $OUTDATED_COUNT package(s) have available updates" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Package | Current | Wanted | Latest |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            cat outdated.json | jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Check dependency licenses
        run: |
          echo "::group::License Check"
          npm install -g license-checker || true
          npx license-checker --summary || true
          echo "::endgroup::"
        continue-on-error: true

      - name: Analyze bundle size impact
        run: |
          echo "::group::Package Sizes"
          du -sh node_modules/* | sort -h | tail -20
          echo "::endgroup::"
        continue-on-error: true

  # ==================================================================
  # Job 4: Code Quality & Linting
  # ==================================================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "::warning::Linting issues found"
        continue-on-error: true

      - name: Check for TODO comments
        run: |
          echo "::group::TODO Comments"
          grep -r "TODO\|FIXME\|XXX\|HACK" src/ bin/ --color=always || echo "No TODOs found âœ“"
          echo "::endgroup::"
        continue-on-error: true

      - name: Analyze code complexity
        run: |
          echo "::group::Code Statistics"
          echo "Source files:"
          find src/ -name "*.js" | wc -l
          echo "Lines of code:"
          find src/ -name "*.js" -exec cat {} \; | wc -l
          echo "::endgroup::"

  # ==================================================================
  # Job 5: Full Repository Scan (Including Test Apps)
  # ==================================================================
  full-repository-scan:
    name: Full Repository Scan (For Reference)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Full DepGuard scan (including test apps)
        run: |
          echo "::group::Full Repository Scan"
          echo "âš ï¸ Note: This includes intentionally vulnerable test applications"
          node bin/depguard.js scan -p . --deep-analysis -o json -f depguard-full.json
          node bin/depguard.js scan -p . --deep-analysis
          echo "::endgroup::"

      - name: Generate comparison report
        run: |
          FULL_VULNS=$(jq -r '.statistics.reachableVulnerabilities // 0' depguard-full.json)

          echo "## Full Repository Scan (Reference)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This scan includes intentionally vulnerable test applications." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total reachable vulnerabilities: $FULL_VULNS" >> $GITHUB_STEP_SUMMARY
          echo "- Production code: See 'Production Code Security' job" >> $GITHUB_STEP_SUMMARY
          echo "- Test apps: Remaining vulnerabilities (intentional)" >> $GITHUB_STEP_SUMMARY

      - name: Upload full report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: depguard-full-report
          path: depguard-full.json
          retention-days: 30

  # ==================================================================
  # Job 6: Security Summary
  # ==================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [production-security-audit, test-suite, dependency-health]
    if: always()

    steps:
      - name: Generate final summary
        run: |
          echo "# ðŸ›¡ï¸ Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.production-security-audit.result == 'success' && needs.test-suite.result == 'success' && 'âœ… All checks passed' || 'âš ï¸ Some checks need attention' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Production Security | ${{ needs.production-security-audit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.test-suite.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Health | ${{ needs.dependency-health.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed reports in the job artifacts above." >> $GITHUB_STEP_SUMMARY
